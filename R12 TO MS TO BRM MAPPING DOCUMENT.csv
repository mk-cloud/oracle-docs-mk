R12 TO MS TO BRM MAPPING DOCUMENT
ADEP-93548 - Chile Invoice Rejection Integration
Version 1.0
Generated: 2025-01-14

===== SECTION 1: FIELD MAPPING =====

R12 Field,R12 Source Table/Logic,R12 Example Value,R12 Data Type,MS JSON Field,MS JSON Path,MS JSON Example,MS JSON Data Type,BRM XML Field,BRM XML Path,BRM XML Example,BRM XML Data Type,Mandatory,Notes
customer_id,Extracted from hz_cust_accounts.account_number,340001,String,URL Path Parameter,/v1/customer/{customer_id}/invoices/rejections,340001,String,N/A (Not sent to BRM),N/A,N/A,N/A,Yes,"Extracted from accountNo prefix (e.g., ""BillTo-340001"" → ""340001""). Used for routing and authorization in MS REST API."
action,Hardcoded/Configuration,FULL_INVOICE_REVERSAL,String,data.action,$.data.action,FULL_INVOICE_REVERSAL,String,ACTION,bus:ACTION,FULL_INVOICE_REVERSAL,String,Yes,Defines the type of operation. Always FULL_INVOICE_REVERSAL for invoice rejections.
program_name,Hardcoded,R12 API,String,data.programName,$.data.programName,R12 API,String,PROGRAM_NAME,bus:PROGRAM_NAME,R12 API,String,Yes,"Identifies the calling system. Always ""R12 API"" for R12 integrations."
account_number,hz_cust_accounts.account_number,BillTo-340001,String(60),data.bills.accountNo,$.data.bills.accountNo,BillTo-340001,String,ACCOUNT_NO,bus:BILLS/bus:ACCOUNT_NO,BillTo-340001,String,Yes,Billing account number. Must correspond to customer_id in URL path.
invoice_number,ra_customer_trx_all.trx_number,3000000702,String(60),data.bills.billNo,$.data.bills.billNo,3000000702,String,BILL_NO,bus:BILLS/bus:BILL_NO,3000000702,String,Yes,Azorian invoice number that needs reversal. Must exist in BRM system.
original_invoice_number,ra_customer_trx_all.trx_number (same as invoice_number),3000000702,String(60),data.bills.origNum,$.data.bills.origNum,3000000702,String,ORIG_NUM,bus:BILLS/bus:ORIG_NUM,3000000702,String,Yes,Original BRM invoice number. Typically same as billNo.
suppression_flag,Business Logic/Configuration,Y,String(1),data.bills.actionType,$.data.bills.actionType,Y,String,ACTION_TYPE,bus:BILLS/bus:ACTION_TYPE,Y,String,Optional,Y = Suppress invoice from further processing. N = Do not suppress. Depends on reason code.
suppression_comment,User Input/Configuration,Suppression Comment,String,data.bills.actionDescr,$.data.bills.actionDescr,Suppression Comment,String,ACTION_DESCR,bus:BILLS/bus:ACTION_DESCR,Suppression Comment,String,Conditional,Required if actionType = N. Free text comment about suppression decision.
suppression_reason,User Input/Reason Code Mapping,Credit Due to Billing Correction,String(120),data.bills.descr,$.data.bills.descr,Credit Due to Billing Correction,String,DESCR,bus:BILLS/bus:DESCR,Suppression Reason,String,Conditional,"Required if actionType = Y. Reason for suppression. If blank and actionType=Y, reasonCode is copied here."
rejection_reason,Lookup Table/User Selection,Customer Rejection,String(255),data.bills.reasonCode,$.data.bills.reasonCode,Customer Rejection,String,REASON_CODE,bus:BILLS/bus:REASON_CODE,Customer Rejection,String,Yes,Must match predefined reason codes. See Reason Code List section. Case sensitive.
transaction_id,Generated Sequence/UUID,1234653,String,data.bills.transId,$.data.bills.transId,1234653,String,TRANS_ID,bus:BILLS/bus:TRANS_ID,ARTAD#,String,Optional,Unique transaction identifier from R12. Used for tracking and idempotency.
N/A (BRM Internal),N/A,N/A,N/A,N/A (Not in JSON),N/A,N/A,N/A,POID,bus:POID,0.0.0.1 /efx_job -1,String,Yes (BRM),BRM internal identifier. Set by MS Team not sent by R12.
N/A (BRM Internal),N/A,N/A,N/A,N/A (Not in JSON),N/A,N/A,N/A,TRANSACTION_ID,bus:TRANSACTION_ID,10009,String,Yes (BRM),BRM transaction ID. Generated by MS Team different from R12 transId.
N/A (BRM Internal),N/A,N/A,N/A,N/A (Not in JSON),N/A,N/A,N/A,USER_NAME,bus:USER_NAME,weblogic,String,Yes (BRM),BRM service account username. Set by MS Team not sent by R12.

===== SECTION 2: VALID REASON CODES =====

Reason Code,Usage Description,Action Type Recommendation,Example Scenario,Business Context
Customer Rejection,Customer disputes or rejects the invoice,Y or N,Customer claims services not received,Common rejection requiring investigation
SII Rejection,Chilean tax authority (SII) rejects the invoice,Y,Invoice format not compliant with SII requirements,Tax compliance issue
Proforma cancellation,Proforma invoice needs to be cancelled,Y,Quote converted to final invoice proforma no longer needed,Normal business process
Government Rejection,Government entity rejects the invoice,Y,Government agency disputes charges,Requires special handling
Anula Documento de Referencia,Cancel reference document (Spanish),Y,Reference document needs to be voided,Chilean specific requirement
Corrige Texto Documento de Referencia,Correct text in reference document (Spanish),N,Text correction needed in referenced invoice,Minor correction scenario
Corrige,General correction (Spanish),N,Invoice requires correction,Generic correction code
Proforma Customer Rejection,Customer rejects proforma invoice,Y,Customer rejects quote before final invoice,Pre-invoice stage rejection
Credit Due to Billing Correction,Billing error requires credit,N,Amount charged incorrectly credit needed,Internal billing error

===== SECTION 3: API ENDPOINTS BY ENVIRONMENT =====

Environment,MS REST Endpoint URL,BRM SOAP Endpoint URL,Authentication Type,Status,Notes
Development,https://dev-api.equifax.com/v1/customer/{customer_id}/invoices/rejections,https://dev-ipatlbrmd04a01.afs.aws.efx:4056/BrmWebServices/BRMfm_efxServices_v2?WSDL,Bearer Token / API Key,Active,Development environment for initial testing
QA/UAT,https://qa-api.equifax.com/v1/customer/{customer_id}/invoices/rejections,https://qa-ipatlbrmd04a01.afs.aws.efx:4056/BrmWebServices/BRMfm_efxServices_v2?WSDL,Bearer Token / API Key,Active,Quality assurance and user acceptance testing
Production,https://api.equifax.com/v1/customer/{customer_id}/invoices/rejections,https://ipatlbrmd04a01.afs.aws.efx:4056/BrmWebServices/BRMfm_efxServices_v2?WSDL,Bearer Token / API Key,Active,Live production environment

Authentication Details:
Method: Bearer Token / API Key (Contact MS Team for credentials)
Header: Authorization: Bearer <token>
Content-Type: application/json
HTTP Method: POST

===== SECTION 4: PROCESS FLOW (16 STEPS) =====

Step,System,Action,Details,Typical Duration,Output/Result,Error Handling
1,R12,Identify invoice for reversal,Query ra_customer_trx_all for invoice details,< 1 second,Invoice data retrieved,Retry if database error
2,R12,Extract customer_id from account number,"Parse ""BillTo-340001"" → extract ""340001""",< 1 second,customer_id extracted,Validation error if format incorrect
3,R12,Build JSON payload,Map R12 fields to MS JSON schema,< 1 second,Complete JSON request,Schema validation before send
4,R12,Call MS REST API,POST /v1/customer/{customer_id}/invoices/rejections,1-3 seconds,HTTP 202 or 400 response,Implement retry with backoff
5,MS,Validate customer_id in URL path,Check if customer exists and R12 has permission,< 100 milliseconds,Validation passed or 404 error,Return error immediately
6,MS,Validate JSON payload,Schema validation mandatory fields data types,< 100 milliseconds,Validation passed or 400 error,Return detailed error message
7,MS,Transform JSON to XML,Convert JSON to BRM SOAP XML format,< 200 milliseconds,XML SOAP payload generated,Log transformation errors
8,MS,Call BRM SOAP endpoint,Submit XML to BRM WebService,2-5 seconds,SOAP response received,Retry on timeout
9,BRM,Validate invoice and account,Check if invoice exists account valid,1-2 seconds,Validation result,Return specific error code
10,BRM,Process invoice reversal,Create reversal transaction update billing tables,5-30 seconds,Batch ID generated,May retry if sync issue
11,BRM,Return SOAP response,Send back batch ID status error codes,< 1 second,XML response to MS,Include correlation ID
12,MS,Store transaction in MySQL,Save transactionId customerId status payloads,< 500 milliseconds,Database record created,Ensure transactional integrity
13,MS,Transform XML to JSON,Convert BRM response to JSON format,< 200 milliseconds,JSON response prepared,Handle transformation errors
14,MS,Return HTTP response to R12,Send 202 Accepted or 400 Bad Request,< 100 milliseconds,HTTP response sent,Include correlation ID
15,R12,Process response,Log transaction update status handle errors,< 1 second,Status updated in R12,Alert on errors
16,R12,Generate credit memo (if applicable),Create credit memo in AR module,2-5 seconds,Credit memo created,Business validation required

Total Process Time: 10-50 seconds (typical: 15-20 seconds)

===== SECTION 5: ERROR CODES AND HANDLING =====

Error Code,HTTP Status,System,Description,Root Cause,Recommended Action,Retry Strategy
EFX_JOB_VALIDATION_SUCCESS,202,BRM,Job submitted successfully,Validation passed,Log success and proceed,N/A - Success
EFX_BRM_SUCCESS,202,BRM,BRM processing completed successfully,Reversal completed,Update status generate credit memo,N/A - Success
INVALID_CUSTOMER_ID,404,MS,Customer ID not found,Customer does not exist in system,Verify customer_id check mapping logic,No retry - Fix data
CUSTOMER_MISMATCH,400,MS,customer_id in path does not match accountNo,Extraction logic error,Fix customer_id extraction in R12,No retry - Fix logic
MISSING_MANDATORY_FIELD,400,MS,Required field is missing from payload,Incomplete payload,Check payload add missing field,No retry - Fix payload
INVALID_REASON_CODE,400,MS/BRM,Reason code not in approved list,Invalid or typo in reason code,Use valid reason code from approved list,No retry - Fix code
BILL_NOT_FOUND,400,BRM,Invoice number not found in BRM,Azorian bill not synced yet,Wait for sync retry after 6 hours,Yes - Retry with delay
INVALID_ACCOUNT_NO,400,BRM,Account number invalid or inactive,Account does not exist or closed,Verify account number in BRM system,No retry - Verify account
DUPLICATE_TRANSACTION,409,MS,Transaction ID already processed,Duplicate submission,Check if already reversed idempotency,No retry - Check status
AUTHENTICATION_FAILED,401,MS,Invalid or expired credentials,Token expired or invalid,Refresh token check credentials,Yes - After token refresh
AUTHORIZATION_FAILED,403,MS,No permission for this customer,Insufficient permissions,Request access from MS team,No retry - Get permission
RATE_LIMIT_EXCEEDED,429,MS,Too many requests sent,Rate limit hit,Implement exponential backoff,Yes - With backoff
TIMEOUT,504,MS/BRM,Request timeout occurred,Network or processing timeout,Retry check status via EDH dashboard,Yes - Limited retries
BRM_UNAVAILABLE,503,BRM,BRM system is down or unavailable,System maintenance or outage,Wait and retry escalate if persistent,Yes - With longer intervals
INTERNAL_ERROR,500,MS,MS service internal error,Unexpected server error,Contact MS team with correlation ID,Yes - After investigation

===== SECTION 6: TEST SCENARIOS =====

Test Scenario ID,Scenario Name,Customer ID,Account No,Bill No,Reason Code,Action Type,Expected HTTP Status,Expected Outcome,Test Priority,Notes
TS-001,Happy Path - Valid Request,340001,BillTo-340001,3000000702,Customer Rejection,Y,202 Accepted,Successful submission and reversal,High,Complete end-to-end successful flow
TS-002,Invalid Customer ID,INVALID,BillTo-INVALID,3000000702,Customer Rejection,Y,404 Not Found,Customer not found error,High,Customer does not exist in system
TS-003,Customer ID Mismatch,340001,BillTo-999999,3000000702,Customer Rejection,Y,400 Bad Request,Mismatch between path and body,High,Path customer_id does not match accountNo
TS-004,Missing Mandatory Field - billNo,340001,BillTo-340001,null,Customer Rejection,Y,400 Bad Request,Missing mandatory field error,High,billNo is required but not provided
TS-005,Missing Mandatory Field - reasonCode,340001,BillTo-340001,3000000702,null,Y,400 Bad Request,Missing mandatory field error,High,reasonCode is required
TS-006,Invalid Reason Code,340001,BillTo-340001,3000000702,Invalid Reason Text,Y,400 Bad Request,Invalid reason code error,Medium,Reason code not in approved list
TS-007,Bill Not Found (Sync Issue),340001,BillTo-340001,9999999999,Customer Rejection,Y,400 Bad Request,Bill number not found in BRM,Medium,Azorian bill not yet synced - retry scenario
TS-008,Invalid Account Number,340001,BillTo-000000,3000000702,Customer Rejection,Y,400 Bad Request,Invalid or inactive account,Medium,Account does not exist in BRM
TS-009,Suppression Flag Y with descr,340001,BillTo-340001,3000000702,SII Rejection,Y,202 Accepted,Successful with suppression,Medium,actionType=Y requires descr not null
TS-010,Suppression Flag N with actionDescr,340001,BillTo-340001,3000000702,Corrige,N,202 Accepted,Successful without suppression,Medium,actionType=N requires actionDescr not null
TS-011,Duplicate Transaction ID,340001,BillTo-340001,3000000702,Customer Rejection,Y,409 Conflict,Duplicate transaction detected,Low,Same transId sent twice
TS-012,Authentication Failure,340001,BillTo-340001,3000000702,Customer Rejection,Y,401 Unauthorized,Invalid or expired token,High,Invalid authentication credentials
TS-013,Authorization Failure,999999,BillTo-999999,3000000702,Customer Rejection,Y,403 Forbidden,No permission for customer,Medium,R12 lacks permission for customer
TS-014,Timeout Scenario,340001,BillTo-340001,3000000702,Customer Rejection,Y,504 Gateway Timeout,Request timeout,Low,Simulate slow BRM response
TS-015,Large Payload Test,340001,BillTo-340001,3000000702,Customer Rejection with very long description text,Y,202 or 400,Test field length limits,Low,Test maximum field lengths

===== SECTION 7: SAMPLE PAYLOADS =====

=== R12 to MS - JSON Request Example ===
{
  "data": {
    "action": "FULL_INVOICE_REVERSAL",
    "programName": "R12 API",
    "bills": {
      "accountNo": "BillTo-340001",
      "billNo": "3000000702",
      "origNum": "3000000702",
      "actionType": "Y",
      "actionDescr": "Suppression Comment",
      "descr": "Credit Due to Billing Correction",
      "reasonCode": "Customer Rejection",
      "transId": "1234653"
    }
  }
}

=== MS to BRM - XML SOAP Request Example ===
<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:bus="http://xmlns.oracle.com/BRM/schemas/BusinessOpcodes">
  <soapenv:Header/>
  <soapenv:Body>
    <bus:efxOpMsJobSubmissionRequest>
      <bus:EFX_OP_MS_JOB_SUBMISSION_Request>
        <bus:flags>0</bus:flags>
        <bus:EFX_OP_MS_JOB_SUBMISSION_inputFlist>
          <bus:ACTION>FULL_INVOICE_REVERSAL</bus:ACTION>
          <bus:BILLS elem="0">
            <bus:ACCOUNT_NO>BillTo-340001</bus:ACCOUNT_NO>
            <bus:ACTION_DESCR>Suppression Comment</bus:ACTION_DESCR>
            <bus:ACTION_TYPE>Y</bus:ACTION_TYPE>
            <bus:BILL_NO>3000000702</bus:BILL_NO>
            <bus:ORIG_NUM>3000000702</bus:ORIG_NUM>
            <bus:DESCR>Credit Due to Billing Correction</bus:DESCR>
            <bus:REASON_CODE>Customer Rejection</bus:REASON_CODE>
            <bus:TRANS_ID>ARTAD#</bus:TRANS_ID>
          </bus:BILLS>
          <bus:POID>0.0.0.1 /efx_job -1</bus:POID>
          <bus:PROGRAM_NAME>R12 API</bus:PROGRAM_NAME>
          <bus:TRANSACTION_ID>10009</bus:TRANSACTION_ID>
          <bus:USER_NAME>weblogic</bus:USER_NAME>
        </bus:EFX_OP_MS_JOB_SUBMISSION_inputFlist>
      </bus:EFX_OP_MS_JOB_SUBMISSION_Request>
    </bus:efxOpMsJobSubmissionRequest>
  </soapenv:Body>
</soapenv:Envelope>

=== BRM to MS - XML SOAP Response Example (Success) ===
<brm:efxOpMsJobSubmissionResponse xmlns:brm="http://xmlns.oracle.com/BRM/schemas/BusinessOpcodes">
  <brm:BATCH_ID>1000000784</brm:BATCH_ID>
  <brm:BILLS elem="0">
    <brm:ACCOUNT_NO>BillTo-340001</brm:ACCOUNT_NO>
    <brm:BILL_NO>3000000702</brm:BILL_NO>
    <brm:ERROR_CODE>EFX_JOB_VALIDATION_SUCCESS</brm:ERROR_CODE>
    <brm:ERROR_DESCR>EFX_JOB_VALIDATION_SUCCESS</brm:ERROR_DESCR>
  </brm:BILLS>
  <brm:CONTEXT_INFO>
    <brm:CORRELATION_ID>17S4854292489T32</brm:CORRELATION_ID>
  </brm:CONTEXT_INFO>
  <brm:CODE>EFX_BRM_SUCCESS</brm:CODE>
  <brm:DESCR>EFX_BRM_SUCCESS</brm:DESCR>
  <brm:POID>0.0.0.1 /efx_job -10</brm:POID>
  <brm:PROCESS_END_T>2025-01-09T02:52:06-0500A</brm:PROCESS_END_T>
  <brm:PROGRAM_NAME>R12 API</brm:PROGRAM_NAME>
  <brm:TRANSACTION_ID>10009</brm:TRANSACTION_ID>
</brm:efxOpMsJobSubmissionResponse>

=== MS to R12 - JSON Response Example (Success) ===
{
  "status": "SUBMITTED",
  "transactionId": "10009",
  "batchId": "1000000784",
  "customerId": "340001",
  "correlationId": "17S4854292489T32",
  "message": "Invoice reversal request submitted successfully"
}

=== MS to R12 - JSON Response Example (Error) ===
{
  "error": "INVALID_REASON_CODE",
  "errorCode": "400",
  "message": "Reason code 'Invalid Reason' is not in the approved list",
  "transactionId": "10009",
  "timestamp": "2025-01-14T10:30:00Z"
}

===== SECTION 8: QUESTIONS FOR MS TEAM WALKTHROUGH =====

Category,Priority,Question,Why Important
Endpoint Configuration,Critical,What are the exact endpoint URLs for Dev QA and Production?,Need accurate URLs for all environments
Authentication,Critical,What authentication method is used and how do we obtain credentials?,Cannot make any API calls without this
customer_id Logic,Critical,How exactly should we derive customer_id from R12 data?,Core to the integration - must be correct
Error Codes,High,Can you provide the complete error code list with HTTP status codes?,Essential for error handling and debugging
Status Checking,High,How do we check job status after submission? Is there a status API?,Need to verify completion for async process
EDH Dashboard,High,How do we access EDH Dashboard? URL credentials API availability?,Required for monitoring and troubleshooting
Field Validation,High,What are the exact validation rules for each field?,Prevent validation errors in production
actionType Logic,Medium,Can you provide clear examples for actionType descr actionDescr usage?,Documentation is confusing on this
Reason Codes,Medium,Is the reason code list complete or are there additional codes?,Need complete list for validation
Sync Delays,Medium,What is typical Azorian bill number sync delay?,Helps determine retry strategy
Rate Limits,Medium,What are the rate limits (requests per second/minute/hour)?,Need to implement proper throttling
Timeout Settings,Medium,What are connection and read timeout values?,Configure R12 client appropriately
Test Environment,Medium,How do we get test data and test accounts?,Essential for integration testing
Retry Strategy,Medium,Should R12 implement retries? With what backoff strategy?,Determine retry responsibility
Monitoring,Low,How are we notified of system issues or alerts?,Understand support and monitoring
Support Process,Low,What is the support SLA and escalation path?,Know who to contact for issues

===== SECTION 9: IMPLEMENTATION CHECKLIST =====

Phase,Task,Owner,Status,Notes
Requirements,Review complete mapping document,R12 Team,Pending,This document
Requirements,Schedule walkthrough with MS Team,R12 Team,Pending,Ask all questions from Section 8
Requirements,Obtain API credentials for all environments,R12 Team,Pending,Request from MS Team
Design,Design customer_id extraction logic,R12 Dev,Pending,Parse accountNo to extract ID
Design,Design JSON payload builder,R12 Dev,Pending,Map R12 fields to MS JSON
Design,Design error handling framework,R12 Dev,Pending,Handle all error codes from Section 5
Design,Design retry mechanism,R12 Dev,Pending,Implement exponential backoff
Design,Design logging and monitoring,R12 Dev,Pending,Log all requests and responses
Development,Implement customer_id extraction,R12 Dev,Pending,Unit test thoroughly
Development,Implement JSON payload builder,R12 Dev,Pending,Validate against schema
Development,Implement REST API client,R12 Dev,Pending,Handle authentication and timeouts
Development,Implement error handling,R12 Dev,Pending,Map error codes to actions
Development,Implement retry logic,R12 Dev,Pending,Test retry scenarios
Development,Implement transaction logging,R12 Dev,Pending,Store all transaction details
Testing,Unit testing,R12 Dev,Pending,Test all functions individually
Testing,Integration testing in DEV,R12 QA,Pending,Test against MS DEV endpoint
Testing,Execute all test scenarios,R12 QA,Pending,Run all scenarios from Section 6
Testing,Performance testing,R12 QA,Pending,Test under load
Testing,UAT with business users,Business,Pending,Validate business scenarios
Deployment,Deploy to QA environment,DevOps,Pending,QA environment deployment
Deployment,QA regression testing,R12 QA,Pending,Full regression suite
Deployment,Production deployment,DevOps,Pending,Deploy during maintenance window
Deployment,Production smoke testing,R12 QA,Pending,Verify production works
Post-Deployment,Monitor for 48 hours,R12 Support,Pending,Watch for issues
Post-Deployment,Knowledge transfer to support,R12 Team,Pending,Document support procedures

===== DOCUMENT METADATA =====

Document Title: R12 to MS to BRM Integration Mapping Document
Project: Chile Invoice Rejection Integration
JIRA Ticket: ADEP-93548
Version: 1.0
Created Date: 2025-01-14
Created By: R12 Development Team
Last Updated: 2025-01-14
Status: Draft
Distribution: R12 Team MS Team BRM Team
Classification: Internal Use Only

===== END OF DOCUMENT =====